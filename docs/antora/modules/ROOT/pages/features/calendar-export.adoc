= Calendar Export (ICS)
:description: Export events to calendar applications using ICS format
:keywords: ics, icalendar, calendar, export, rfc5545

Veidly allows users to export events to their calendar applications using the industry-standard ICS (iCalendar) format.

== Overview

The ICS export feature enables users to:

* Download event details as `.ics` files
* Import events into calendar applications
* Receive automatic reminders
* Keep event details synchronized

Supported calendar applications:

* **Google Calendar**
* **Apple Calendar** (macOS, iOS)
* **Microsoft Outlook**
* **Mozilla Thunderbird**
* Any RFC 5545 compliant calendar application

== How to Export an Event

=== From Map View

1. Click on an event marker on the map
2. In the popup, click **"üìÖ Add to Calendar"**
3. The `.ics` file downloads automatically

=== From Event Detail Page

1. Navigate to the event page (e.g., `/event/bike-tour-073db950`)
2. Click **"üìÖ Add to Calendar"** button
3. The `.ics` file downloads automatically

=== Using the API

Make a GET request to the ICS endpoint:

[source,bash]
----
curl -o event.ics https://veidly.com/api/public/events/bike-tour-073db950/ics
----

No authentication required - ICS export is public for all events.

== ICS File Format

Veidly generates RFC 5545 compliant ICS files:

=== Example ICS File

[source,ics]
----
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Veidly//Event Calendar//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:Veidly Event
X-WR-TIMEZONE:UTC

BEGIN:VEVENT
UID:bike-tour-073db950@veidly.com
DTSTAMP:20251015T120000Z
DTSTART:20251020T140000Z
DTEND:20251020T160000Z
SUMMARY:Morning Bike Tour through Countryside
DESCRIPTION:Join us for a scenic 25km bike ride through the beautiful countryside. Suitable for intermediate riders.\n\nBring: Bike\, helmet\, water\n\nJoin at: https://veidly.com/event/bike-tour-073db950
LOCATION:Warsaw\, Poland (52.2297\, 21.0122)
GEO:52.2297;21.0122
URL:https://veidly.com/event/bike-tour-073db950
ORGANIZER;CN="John Doe":mailto:john@example.com
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT

END:VCALENDAR
----

=== ICS Fields Explained

[options="header"]
|===
|Field |Description |Example

|`UID`
|Unique identifier for the event
|`bike-tour-073db950@veidly.com`

|`DTSTAMP`
|Timestamp when ICS was generated
|`20251015T120000Z`

|`DTSTART`
|Event start time (UTC)
|`20251020T140000Z`

|`DTEND`
|Event end time (UTC)
|`20251020T160000Z`

|`SUMMARY`
|Event title
|`Morning Bike Tour through Countryside`

|`DESCRIPTION`
|Event description + join URL
|Full event description with link

|`LOCATION`
|Human-readable location
|`Warsaw, Poland (52.2297, 21.0122)`

|`GEO`
|Geographic coordinates
|`52.2297;21.0122`

|`URL`
|Link to event page
|`https://veidly.com/event/...`

|`ORGANIZER`
|Event organizer
|`John Doe <john@example.com>`

|`STATUS`
|Event status
|`CONFIRMED`
|===

== Implementation Details

=== Backend Implementation

The ICS generation is implemented in [ics.go:1-92](../../../../../../ics.go):

[source,go]
----
func GenerateICS(event *Event) string {
    // Parse event times
    startTime, _ := time.Parse(time.RFC3339, event.StartTime)
    endTime, _ := time.Parse(time.RFC3339, event.EndTime)

    // Format for ICS (UTC)
    startICS := startTime.UTC().Format("20060102T150405Z")
    endICS := endTime.UTC().Format("20060102T150405Z")
    nowICS := time.Now().UTC().Format("20060102T150405Z")

    // Build description with join URL
    description := event.Description
    if event.Slug != "" {
        joinURL := fmt.Sprintf("https://veidly.com/event/%s", event.Slug)
        description = fmt.Sprintf("%s\\n\\nJoin at: %s",
            escapeICS(event.Description),
            joinURL)
    }

    // Build ICS content
    var ics strings.Builder
    ics.WriteString("BEGIN:VCALENDAR\r\n")
    ics.WriteString("VERSION:2.0\r\n")
    // ... more fields ...
    ics.WriteString("END:VCALENDAR\r\n")

    return ics.String()
}
----

Key functions:

* `GenerateICS(event *Event)` - Main ICS generation function
* `escapeICS(s string)` - Escapes special characters per RFC 5545

=== API Endpoint

Route: `GET /api/public/events/:slug/ics`

Handler: `downloadEventICS()` in [handlers.go](../../../../../../handlers.go)

[source,go]
----
func downloadEventICS(c *gin.Context) {
    slug := c.Param("slug")

    // Fetch event from database
    var e Event
    err := db.QueryRow(`
        SELECT id, title, description, slug, latitude, longitude,
               start_time, end_time, creator_name, creator_contact
        FROM events
        WHERE slug = ?
    `, slug).Scan(&e.ID, &e.Title, /* ... */)

    if err != nil {
        c.JSON(http.StatusNotFound, gin.H{"error": "Event not found"})
        return
    }

    // Generate ICS content
    icsContent := GenerateICS(&e)

    // Set headers for file download
    filename := fmt.Sprintf("%s.ics", slug)
    c.Header("Content-Type", "text/calendar; charset=utf-8")
    c.Header("Content-Disposition", fmt.Sprintf("attachment; filename=\"%s\"", filename))

    c.String(http.StatusOK, icsContent)
}
----

=== Frontend Integration

The frontend triggers ICS download via simple URL opening:

**MapView popup** - [MapView.tsx:430-439](../../../../../../frontend/src/components/MapView.tsx#L430-L439):

[source,typescript]
----
<button
  className="download-ics-button"
  onClick={(e) => {
    e.stopPropagation()
    window.open(
      `${import.meta.env.VITE_API_URL}/api/public/events/${event.slug}/ics`,
      '_blank'
    )
  }}
>
  üìÖ Add to Calendar
</button>
----

**Event detail page** - [PublicEventPage.tsx:77-79](../../../../../../frontend/src/pages/PublicEventPage.tsx#L77-L79):

[source,typescript]
----
const handleDownloadICS = () => {
  window.open(`${import.meta.env.VITE_API_URL}/api/public/events/${slug}/ics`, '_blank')
}
----

== Character Escaping

ICS format requires special character escaping per RFC 5545:

=== Escape Rules

[options="header"]
|===
|Character |Escaped As |Reason

|Backslash (`\`)
|`\\`
|Escape character itself

|Semicolon (`;`)
|`\;`
|Field delimiter

|Comma (`,`)
|`\,`
|List separator

|Newline (`\n`)
|`\\n`
|Line break representation
|===

=== Escape Implementation

[source,go]
----
func escapeICS(s string) string {
    s = strings.ReplaceAll(s, "\\", "\\\\")  // Backslash first
    s = strings.ReplaceAll(s, ";", "\\;")
    s = strings.ReplaceAll(s, ",", "\\,")
    s = strings.ReplaceAll(s, "\n", "\\n")
    return s
}
----

=== Why Escaping Matters

Without proper escaping:

* **Description breaks** if it contains semicolons
* **Location parsing fails** if it contains commas
* **Calendar import errors** in most applications

Example problem:

[source,ics]
----
DESCRIPTION:Bring: Bike, helmet, water   ‚Üê BROKEN (unescaped comma)
DESCRIPTION:Bring: Bike\, helmet\, water ‚Üê CORRECT (escaped commas)
----

== Importing ICS Files

=== Google Calendar

1. **Open Google Calendar** (calendar.google.com)
2. **Click the downloaded `.ics` file**
3. **Select "Google Calendar"** as the app to open it
4. Event is automatically added to your calendar

Alternative method:
1. Google Calendar ‚Üí Settings ‚Üí Import & Export
2. Select the `.ics` file
3. Choose destination calendar
4. Click "Import"

=== Apple Calendar (macOS/iOS)

**macOS:**
1. **Double-click the `.ics` file**
2. Calendar app opens automatically
3. Choose destination calendar
4. Click "Add"

**iOS:**
1. **Tap the `.ics` file** in Mail or Files
2. Tap "Add to Calendar"
3. Event is added to default calendar

=== Microsoft Outlook

**Outlook Desktop:**
1. **Open Outlook**
2. **Go to** File ‚Üí Open & Export ‚Üí Import/Export
3. **Select** "Import an iCalendar (.ics) file"
4. **Choose** the `.ics` file
5. Click "Import"

**Outlook Web:**
1. **Drag and drop** the `.ics` file into Outlook calendar
2. Event is automatically added

=== Thunderbird

1. **Open Thunderbird Calendar**
2. **Go to** Events and Tasks ‚Üí Import
3. **Select** the `.ics` file
4. **Choose** destination calendar
5. Click "Open"

== Time Zone Handling

Veidly uses UTC for all time storage and ICS export:

=== Why UTC?

* **Consistency** across different time zones
* **No ambiguity** during DST transitions
* **Portable** - works regardless of user location

=== Conversion in Calendar Apps

Calendar applications automatically convert UTC times to local time:

* **Event at**: `20251020T140000Z` (2:00 PM UTC)
* **User in New York (EDT)**: Sees 10:00 AM
* **User in Warsaw (CEST)**: Sees 4:00 PM

=== Future Enhancement: Time Zone Support

Currently planned for a future release:

* Store event time zone
* Include `TZID` in ICS files
* Allow organizers to specify time zone

[source,ics]
----
BEGIN:VEVENT
DTSTART;TZID=Europe/Warsaw:20251020T140000
DTEND;TZID=Europe/Warsaw:20251020T160000
...
END:VEVENT
----

== Testing ICS Export

=== Manual Testing

1. **Create test event** with various special characters:
   - Description with commas, semicolons
   - Location with special characters
   - Long description (test line breaking)

2. **Download ICS file**

3. **Validate ICS syntax** using online validator:
   - https://icalendar.org/validator.html

4. **Import into calendar applications**:
   - Test with Google Calendar
   - Test with Apple Calendar
   - Test with Outlook

5. **Verify display**:
   - Correct time (in local time zone)
   - Correct location (with coordinates)
   - Correct organizer
   - Clickable URL to event

=== Automated Testing

Backend test in [handlers_test.go](../../../../../../handlers_test.go):

[source,go]
----
func TestDownloadEventICS(t *testing.T) {
    // Create test event
    event := createTestEvent()

    // Request ICS endpoint
    w := httptest.NewRecorder()
    req, _ := http.NewRequest("GET", "/api/public/events/"+event.Slug+"/ics", nil)
    router.ServeHTTP(w, req)

    // Verify response
    assert.Equal(t, 200, w.Code)
    assert.Contains(t, w.Header().Get("Content-Type"), "text/calendar")
    assert.Contains(t, w.Body.String(), "BEGIN:VCALENDAR")
    assert.Contains(t, w.Body.String(), event.Title)
}
----

Run tests:

[source,bash]
----
go test -v -run TestDownloadEventICS
----

== Common Issues and Solutions

=== Issue: Calendar App Shows Wrong Time

**Cause**: Time zone conversion issue

**Solution**:
* Verify ICS uses UTC format (`20251020T140000Z` with `Z`)
* Check calendar app time zone settings
* Ensure event times in database are in UTC

=== Issue: Special Characters Display Incorrectly

**Cause**: Missing character escaping

**Solution**:
* Use `escapeICS()` function for all text fields
* Test with strings containing `;`, `,`, `\`, and `\n`

=== Issue: Calendar App Won't Import

**Cause**: Invalid ICS format

**Solution**:
* Validate ICS file at https://icalendar.org/validator.html
* Check for missing required fields (UID, DTSTART, DTEND, SUMMARY)
* Verify line endings are `\r\n` (CRLF), not just `\n`

=== Issue: Location Doesn't Show Map

**Cause**: Missing or incorrect `GEO` field

**Solution**:
* Include `GEO:latitude;longitude` field
* Use semicolon (`;`) as separator, not comma
* Verify coordinates are valid (-90 to 90 for lat, -180 to 180 for lng)

=== Issue: Event URL Not Clickable

**Cause**: Missing `URL` field in ICS

**Solution**:
* Include `URL:https://veidly.com/event/slug` field
* Ensure URL is properly formatted with `https://`

## Security Considerations

=== No Authentication Required

ICS export is intentionally public:

* **Pro**: Easy sharing, no login needed for calendar import
* **Con**: Anyone with slug can export event

This aligns with the public event model - if an event is public, its ICS should be too.

=== Privacy and ICS

ICS files respect privacy settings:

* **Organizer info**: Included in ICS if event allows
* **Participant list**: Never included in ICS
* **Contact info**: Only included if user has permission

=== Sensitive Events

For highly private events, consider:

1. Use privacy controls to hide organizer
2. Avoid including sensitive info in description
3. Use generic event titles
4. Implement future feature: password-protected ICS

== Future Enhancements

Planned features for ICS export:

=== 1. Recurring Events

Support for recurring event series:

[source,ics]
----
RRULE:FREQ=WEEKLY;BYDAY=MO;COUNT=10
----

=== 2. Event Updates

When event details change, send update notifications:

[source,ics]
----
METHOD:REQUEST
SEQUENCE:1
----

=== 3. Event Cancellations

Send cancellation notices to participants:

[source,ics]
----
METHOD:CANCEL
STATUS:CANCELLED
----

=== 4. Reminders/Alarms

Include reminder alarms in ICS:

[source,ics]
----
BEGIN:VALARM
TRIGGER:-PT1H
DESCRIPTION:Event reminder
ACTION:DISPLAY
END:VALARM
----

=== 5. Attendee List

Include participants as attendees:

[source,ics]
----
ATTENDEE;CN="Jane Smith":mailto:jane@example.com
ATTENDEE;CN="Bob Johnson":mailto:bob@example.com
----

=== 6. Categories and Tags

Event categorization:

[source,ics]
----
CATEGORIES:Sports,Outdoor,Cycling
----

== Best Practices

=== For Organizers

1. **Fill all event details** - Complete info creates better ICS files
2. **Use clear descriptions** - Include what to bring, where to meet
3. **Provide exact location** - Coordinates help with navigation
4. **Set accurate times** - Double-check start and end times
5. **Test the export** - Download and verify your own events

=== For Developers

1. **Always escape text** - Use `escapeICS()` for all user-generated content
2. **Use UTC times** - Store and export everything in UTC
3. **Validate coordinates** - Ensure latitude/longitude are valid
4. **Include all fields** - UID, DTSTAMP, DTSTART, DTEND are required
5. **Test with multiple apps** - Verify compatibility across platforms
6. **Follow RFC 5545** - Adhere to the standard strictly

## API Reference

=== Endpoint

[source]
----
GET /api/public/events/:slug/ics
----

=== Parameters

[options="header"]
|===
|Parameter |Type |Location |Description

|`slug`
|string
|path
|Unique event slug
|===

=== Response

**Success (200 OK)**:

* **Content-Type**: `text/calendar; charset=utf-8`
* **Content-Disposition**: `attachment; filename="{slug}.ics"`
* **Body**: RFC 5545 compliant ICS file

**Error (404 Not Found)**:

[source,json]
----
{
  "error": "Event not found"
}
----

=== Example cURL

[source,bash]
----
curl -O https://veidly.com/api/public/events/bike-tour-073db950/ics
----

== Next Steps

* xref:features/events.adoc[Events Management] - Learn about event creation
* xref:api/events.adoc[Events API] - API reference for events
* xref:features/privacy.adoc[Privacy Controls] - How privacy affects ICS export
* xref:development/testing.adoc[Testing Guide] - Test ICS generation

== Additional Resources

* https://datatracker.ietf.org/doc/html/rfc5545[RFC 5545 - iCalendar Specification]
* https://icalendar.org/[iCalendar.org] - Tools and validators
* https://icalendar.org/validator.html[ICS Validator]
* https://www.kanzaki.com/docs/ical/[iCalendar Quick Reference]
