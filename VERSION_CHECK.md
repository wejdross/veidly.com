# Auto-Reload on Version Change

## Overview

Veidly implements automatic version detection to ensure users always have the latest version of the application without needing to perform hard refreshes manually.

## How It Works

### 1. Version File Generation

During the build process, a `version.json` file is automatically generated with:
- **buildTime**: ISO timestamp of when the build was created
- **version**: Package version from package.json

This file is generated by the Vite plugin in [vite.config.ts](frontend/vite.config.ts) and is automatically copied to the `dist` folder and served at `/version.json`.

### 2. Version Checking

The [useVersionCheck hook](frontend/src/hooks/useVersionCheck.ts) polls the `/version.json` endpoint every 5 minutes to detect changes:

1. On initial load, it fetches and stores the current version
2. Every 5 minutes, it fetches the version file again (with cache-busting)
3. If the `buildTime` or `version` differs from the initial version, it sets a flag

### 3. User Notification

When a new version is detected, the [VersionNotification component](frontend/src/components/VersionNotification.tsx) displays a prominent banner at the top of the screen with:
- Message informing the user a new version is available
- "Reload Now" button to refresh the page and load the new version

The notification is:
- Non-intrusive (doesn't block the UI)
- Dismissible by reloading
- Mobile-responsive
- Styled with a gradient background for visibility

## Benefits

1. **No Hard Refresh Required**: Users are automatically notified when updates are available
2. **User Control**: Users can choose when to reload (not forced)
3. **Cache Busting**: Ensures fresh version checks even with aggressive caching
4. **Production Ready**: Works seamlessly with the Ansible deployment pipeline

## Deployment

The version check works automatically in production:

1. Ansible pulls the latest code and runs `npm run build`
2. Build process generates a new `version.json` with current timestamp
3. New files are deployed to the server
4. Users with the app open will detect the new version within 5 minutes
5. They'll see a notification prompting them to reload

## Configuration

To change the polling interval, modify the `useVersionCheck.ts` hook:

```typescript
// Check every 5 minutes (default)
const interval = setInterval(checkVersion, 5 * 60 * 1000)

// To check every 10 minutes:
const interval = setInterval(checkVersion, 10 * 60 * 1000)
```

## Testing

The version check system is fully tested:
- Unit tests for the VersionNotification component
- All 215 frontend tests passing
- Verified in production builds

## Files Modified/Created

### Created:
- `frontend/src/hooks/useVersionCheck.ts` - Version checking hook
- `frontend/src/components/VersionNotification.tsx` - Notification UI component
- `frontend/src/components/VersionNotification.css` - Notification styles
- `frontend/src/components/VersionNotification.test.tsx` - Component tests
- `frontend/public/version.json` - Generated version file (auto-created during build)

### Modified:
- `frontend/vite.config.ts` - Added version plugin to generate version.json
- `frontend/src/App.tsx` - Added VersionNotification component

## Notes

- The version.json file is excluded from git (generated during build)
- Cache-busting query parameter ensures fresh version data
- Works with both development and production builds
- No server-side changes required (frontend-only implementation)
