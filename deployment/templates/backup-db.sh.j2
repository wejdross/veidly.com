#!/bin/bash
# Veidly Database Backup Script

BACKUP_DIR="{{ backup_dir }}"
DB_PATH="{{ db_dir }}/veidly.db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/veidly_$TIMESTAMP.db"
LOG_FILE="{{ log_dir }}/backup.log"

# Create backup directory if it doesn't exist
mkdir -p $BACKUP_DIR

# Log start
echo "$(date): Starting backup..." >> $LOG_FILE

# Check if database exists
if [ ! -f "$DB_PATH" ]; then
    echo "$(date): ERROR - Database not found at $DB_PATH" >> $LOG_FILE
    exit 1
fi

# Backup database
if sqlite3 $DB_PATH ".backup '$BACKUP_FILE'"; then
    # Compress backup
    gzip $BACKUP_FILE
    
    # Calculate backup size
    BACKUP_SIZE=$(du -h "$BACKUP_FILE.gz" | cut -f1)
    
    echo "$(date): Backup completed successfully - $BACKUP_FILE.gz ($BACKUP_SIZE)" >> $LOG_FILE
    
    # Keep only last 30 backups
    ls -t $BACKUP_DIR/veidly_*.db.gz 2>/dev/null | tail -n +31 | xargs rm -f
    
    # Count remaining backups
    BACKUP_COUNT=$(ls -1 $BACKUP_DIR/veidly_*.db.gz 2>/dev/null | wc -l)
    echo "$(date): Retained $BACKUP_COUNT backups (max 30)" >> $LOG_FILE
else
    echo "$(date): ERROR - Backup failed!" >> $LOG_FILE
    exit 1
fi
